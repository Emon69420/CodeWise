[{"id": "Directory structure:_0", "file": "Directory structure:", "content": "\u2514\u2500\u2500 emon69420-cowin-vaccine-scouting/\n    \u251c\u2500\u2500 CowinService.py\n    \u2514\u2500\u2500 sendRegMails.gs"}, {"id": "CowinService.py_0", "file": "CowinService.py", "content": "================================================\n# -*- coding: utf-8 -*-\n\"\"\"\nCreated on Thu May 5 10:38:32 2021\n@author: Ayush Kapoor\n\"\"\"\n#%% Importing Necessary Libraries\nimport requests\nimport time\nfrom datetime import datetime\nfrom pytz import timezone\nimport json\nimport smtplib,ssl\nfrom json2html import *\nfrom email.mime.multipart import MIMEMultipart\nfrom email.mime.text import MIMEText\nfrom email.utils import formataddr\nfrom openpyxl import load_workbook\nimport urllib3\n\n#%% Variable Declarations\nfile_path = \"C:\\\\Users\\\\ayush.kapoor\\\\Desktop\\\\input.xlsx\" \nwb = load_workbook(filename= file_path,data_only=True)\nsheet = wb['Details']\n\n#%% Function Declarations\n# Function to get data from Google sheets and store it in a local database"}, {"id": "CowinService.py_1", "file": "CowinService.py", "content": "def getfromGSheets():\n    scope = [\"https://spreadsheets.google.com/feeds\",'https://www.googleapis.com/auth/spreadsheets',\"https://www.googleapis.com/auth/drive.file\",\"https://www.googleapis.com/auth/drive\"]     \n    creds = ServiceAccountCredentials.from_json_keyfile_name(\"drive_api.json\", scope)\n    wb = load_workbook(filename= file_path,data_only=True)\n    sheetOffline = wb['Details']\n    client = gspread.authorize(creds)\n    Gsheet = client.open(\"Vaccine Scouting 18-44 Age (Responses)\").sheet1\n    #row = sheet.row_values(3)  # Get a specific row\n    #col = sheet.col_values(3)  # Get a specific column\n    i=2\n    while (Gsheet.cell(i,4)!=None):\n        sheetOffline.cell(i,1).value = Gsheet.cell(i,5).value\n        sheetOffline.cell(i,2).value = Gsheet.cell(i,6).value"}, {"id": "CowinService.py_2", "file": "CowinService.py", "content": "sheetOffline.cell(i,2).value = Gsheet.cell(i,6).value\n        sheetOffline.cell(i,3).value = Gsheet.cell(i,7).value\n        sheetOffline.cell(i,4).value = Gsheet.cell(i,8).value\n        i+=1\n    wb.save(filename=file_path) \n\n# Function to get all the states and districts on the CoWin portal"}, {"id": "CowinService.py_3", "file": "CowinService.py", "content": "def fetchStateDistrict():\n    wb = load_workbook(filename= file_path,data_only=True)\n    sheet = wb['Database']\n    k = 1\n    cowinS = \"https://api.cowin.gov.in/api/v2/admin/location/states/\"\n    stateResp = json.loads(requests.get(cowinS,verify=False).text)\n    for j in range(0,len(stateResp['states'])):\n        cowin_state_url = \"https://api.cowin.gov.in/api/v2/admin/location/districts/\"+ str(stateResp['states'][j]['state_id']) # 1 to 37 for district\n        print(cowin_state_url)\n        distReq = requests.get(cowin_state_url,verify=False)\n        distResp = json.loads(distReq.text)                        \n        for i in range(0,len(distResp['districts'])):\n            k+=1\n            sheet.cell(row=k,column=3).value = distResp['districts'][i]['district_name']"}, {"id": "CowinService.py_4", "file": "CowinService.py", "content": "sheet.cell(row=k,column=3).value = distResp['districts'][i]['district_name']\n            sheet.cell(row=k,column=4).value = distResp['districts'][i]['district_id']\n            sheet.cell(row=k,column=2).value = stateResp['states'][j]['state_id']\n            sheet.cell(row=k,column=1).value = stateResp['states'][j]['state_name']\n    wb.save(filename=file_path)\n    print(\"Database Fetched\")\n    \n# A helper function to make the email text html friendly"}, {"id": "CowinService.py_5", "file": "CowinService.py", "content": "def HTMLReady (str_,name):\n    if(str_ == \"opners\"):\n        return \"<!DOCTYPE html><html><body font-family: Arial;>\"\n    if(str_ == \"mail_header\"):\n        return \"<p>Hi \"+name+','+\"<br><br>We noticed the availability of COVID-19 vaccines at vaccination centres as per your registered location. Please find below the requisite details.\"\n    if(str_ == \"mail_footer\"):\n        return \"<p><br>Thanks,</p>\"\n    if(str_ == \"closers\"):\n        return \"</body></html>\"\n    if(str_ == \"getCss\"):\n        return \"<style>body {  font-family: Arial;}</style>\"\n    return \"\"\n\n# Function to convert the JSON received from the API to HTML"}, {"id": "CowinService.py_6", "file": "CowinService.py", "content": "def JSON2HTML(listObj,name):\n    htmlTable =\"\"\n    htmlTable = HTMLReady(\"openers\",\"\")\n    htmlTable+= HTMLReady(\"mail_header\",name)\n    obj = Json2Html()\n    for i in range(0,len(listObj)):\n        temp = json.loads(json.dumps(listObj[i]))\n        del temp['session_id']\n        temp['slots'] = str(temp['slots']).replace(\":00\",\"\").replace(\"'\",'').replace(\"0\",'').replace('[','').replace(']','')\n        del temp['center']['center_id']\n        temp['center']['center_name'] = temp['center']['center_name']+', '+temp['center']['block_name']+', '+str(temp['center']['pincode'])\n        del temp['center']['block_name']\n        del temp['center']['pincode']\n        temp['center'] = temp['center']['center_name']+' ['+temp['center']['fee_type']+']'\n        htmlTable+= obj.convert(json.dumps(temp))"}, {"id": "CowinService.py_7", "file": "CowinService.py", "content": "htmlTable+= obj.convert(json.dumps(temp))\n        htmlTable+=\"<br>\"\n    htmlTable = htmlTable.replace(\"<ul>\",\"\").replace(\"</ul>\",\"\").replace(\"<li>\",\" \").replace(\"</li>\",\"\")\n    htmlTable = htmlTable.replace(\"date\",\"Date\").replace(\"available_capacity\", \"Available Slots\").replace(\"min_age_limit\",\"Minimum Age\").replace('Available Slots_dose1', 'Available Slots (Dose 1)').replace('Available Slots_dose2', 'Available Slots (Dose 2)')   \n    htmlTable = htmlTable.replace(\"vaccine\",\"Vaccine\").replace(\"slots\",\"Slot Timings\")\n    htmlTable = htmlTable.replace(\"center\",\"Centre Description\")\n    htmlTable+= HTMLReady(\"getCss\",\"\")\n    htmlTable+= HTMLReady(\"mail_footer\",\"\")"}, {"id": "CowinService.py_8", "file": "CowinService.py", "content": "htmlTable+= '<table cellpadding=\"0\" cellspacing=\"0\" class=\"sc-gPEVay eQYmiW\" style=\"vertical-align: -webkit-baseline-middle; font-size: small; font-family: Arial;\"><tbody><tr><td><table cellpadding=\"0\" cellspacing=\"0\" class=\"sc-gPEVay eQYmiW\" style=\"vertical-align: -webkit-baseline-middle; font-size: small; font-family: Arial;\"><tbody><tr><td style=\"vertical-align: top;\"><h3 color=\"#000000\" class=\"sc-fBuWsC eeihxG\" style=\"margin: 0px; font-size: 16px; color: rgb(0, 0, 0);\"><span>Ayush</span><span>&nbsp;</span><span>Kapoor</span></h3><table cellpadding=\"0\" cellspacing=\"0\" class=\"sc-gPEVay eQYmiW\" style=\"vertical-align: -webkit-baseline-middle; font-size: small; font-family: Arial; width: 100%;\"><tbody><tr><td height=\"4\"></td></tr><tr><td color=\"#7389f6\" direction=\"horizontal\""}, {"id": "CowinService.py_9", "file": "CowinService.py", "content": "width: 100%;\"><tbody><tr><td height=\"4\"></td></tr><tr><td color=\"#7389f6\" direction=\"horizontal\" height=\"1\" class=\"sc-jhAzac hmXDXQ\" style=\"width: 100%; border-bottom: 1px solid rgb(115, 137, 246); border-left: none; display: block;\"></td></tr><tr><td height=\"10\"></td></tr></tbody></table><table cellpadding=\"0\" cellspacing=\"0\" class=\"sc-gPEVay eQYmiW\" style=\"vertical-align: -webkit-baseline-middle; font-size: small; font-family: Arial;\"><tbody><tr height=\"20\" style=\"vertical-align: middle;\"><td width=\"30\" style=\"vertical-align: middle;\"><table cellpadding=\"0\" cellspacing=\"0\" class=\"sc-gPEVay eQYmiW\" style=\"vertical-align: -webkit-baseline-middle; font-size: small; font-family: Arial;\"><tbody><tr><td style=\"vertical-align: bottom;\"><span color=\"#7389f6\" width=\"11\" class=\"sc-jlyJG bbyJzT\""}, {"id": "CowinService.py_10", "file": "CowinService.py", "content": "style=\"vertical-align: bottom;\"><span color=\"#7389f6\" width=\"11\" class=\"sc-jlyJG bbyJzT\" style=\"display: block; background-color: rgb(115, 137, 246);\"><img src=\"https://cdn2.hubspot.net/hubfs/53/tools/email-signature-generator/icons/email-icon-2x.png\" color=\"#7389f6\" width=\"13\" class=\"sc-iRbamj blSEcj\" style=\"display: block; background-color: rgb(115, 137, 246);\"></span></td></tr></tbody></table></td><td style=\"padding: 0px;\"><a href=\"mailto:ak246@snu.edu.in\" color=\"#000000\" class=\"sc-gipzik iyhjGb\" style=\"text-decoration: none; color: rgb(0, 0, 0); font-size: 12px;\"><span>ak246@snu.edu.in</span></a></td></tr><tr height=\"25\" style=\"vertical-align: middle;\"><td width=\"30\" style=\"vertical-align: middle;\"><table cellpadding=\"0\" cellspacing=\"0\" class=\"sc-gPEVay eQYmiW\" style=\"vertical-align:"}, {"id": "CowinService.py_11", "file": "CowinService.py", "content": "middle;\"><table cellpadding=\"0\" cellspacing=\"0\" class=\"sc-gPEVay eQYmiW\" style=\"vertical-align: -webkit-baseline-middle; font-size: small; font-family: Arial;\"><tbody><tr><td style=\"vertical-align: bottom;\"><span color=\"#7389f6\" width=\"11\" class=\"sc-jlyJG bbyJzT\" style=\"display: block; background-color: rgb(115, 137, 246);\"><img src=\"https://cdn2.hubspot.net/hubfs/53/tools/email-signature-generator/icons/address-icon-2x.png\" color=\"#7389f6\" width=\"13\" class=\"sc-iRbamj blSEcj\" style=\"display: block; background-color: rgb(115, 137, 246);\"></span></td></tr></tbody></table></td><td style=\"padding: 0px;\"><span color=\"#000000\" class=\"sc-csuQGl CQhxV\" style=\"font-size: 12px; color: rgb(0, 0, 0);\"><span>IN</span></span></td></tr></tbody></table></td><td width=\"40\"><div></div></td><td"}, {"id": "CowinService.py_12", "file": "CowinService.py", "content": "0, 0);\"><span>IN</span></span></td></tr></tbody></table></td><td width=\"40\"><div></div></td><td style=\"vertical-align: top;\"><table cellpadding=\"0\" cellspacing=\"0\" class=\"sc-gPEVay eQYmiW\" style=\"vertical-align: -webkit-baseline-middle; font-size: small; font-family: Arial;\"><tbody><tr><td style=\"text-align: center;\"><table cellpadding=\"0\" cellspacing=\"0\" class=\"sc-gPEVay eQYmiW\" style=\"vertical-align: -webkit-baseline-middle; font-size: small; font-family: Arial; display: inline-block;\"><tbody><tr style=\"text-align: center;\"><td><a href=\"https://www.linkedin.com/in/kapoor-ayush/\" color=\"#4451dd\" class=\"sc-hzDkRC kpsoyz\" style=\"display: inline-block; padding: 0px; background-color: rgb(68, 81, 221);\"><img"}, {"id": "CowinService.py_13", "file": "CowinService.py", "content": "kpsoyz\" style=\"display: inline-block; padding: 0px; background-color: rgb(68, 81, 221);\"><img src=\"https://cdn2.hubspot.net/hubfs/53/tools/email-signature-generator/icons/linkedin-icon-2x.png\" alt=\"linkedin\" color=\"#4451dd\" height=\"24\" class=\"sc-bRBYWo ccSRck\" style=\"background-color: rgb(68, 81, 221); max-width: 135px; display: block;\"></a></td><td width=\"5\"><div></div></td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table></td></tr><tr><td height=\"30\"></td></tr></tbody></table>'"}, {"id": "CowinService.py_14", "file": "CowinService.py", "content": "htmlTable+= HTMLReady(\"closers\",\"\")\n    return htmlTable \n\n# The most crucial function of the entire script that fetches data from the CoWin API"}, {"id": "CowinService.py_15", "file": "CowinService.py", "content": "def fetchDetails(apiURL,districtId,numRows):\n    # Conditions of fetching from the CoWin API\n    min_age = 45\n    capacity = 0\n    local_timezone = timezone(\"Asia/Kolkata\")\n    local_date = local_timezone.localize(datetime.now())\n    api_params = {\"district_id\": districtId, \"date\": local_date.strftime(\"%d-%m-%Y\")}\n    api_request = requests.get(apiURL,params=api_params,verify = False)\n    api_response = json.loads(api_request.text)\n    centers = []\n    for center in api_response[\"centers\"]:\n        centers.append(center[\"name\"])\n    length = len(max(centers, key=len))\n    sessionData = []\n    for center in api_response[\"centers\"]:\n        for session in center[\"sessions\"]:\n            # or (session[\"min_age_limit\"]<min_age and session[\"available_capacity_dose2\"]>capacity)"}, {"id": "CowinService.py_16", "file": "CowinService.py", "content": "if((session[\"min_age_limit\"]<min_age and session[\"available_capacity_dose1\"]>capacity)):\n                session[\"center\"]={\"center_id\":center[\"center_id\"],\"center_name\":center[\"name\"],\"block_name\":center[\"block_name\"],\"pincode\":center[\"pincode\"],\"fee_type\":center[\"fee_type\"]}\n                print(length,center[\"name\"],session[\"date\"],\"SUCCESS\")\n                sessionData.append(session)\n    print('Total 18+ Centres : '+str(len(sessionData)))\n    if(len(sessionData)>0):\n        sendMail(districtId,sessionData,numRows)\n        \n# Function to send mail to the respective users"}, {"id": "CowinService.py_17", "file": "CowinService.py", "content": "def sendMail(districtId,data,numRows):\n    # Server Credentials\n    HOSTNAME = 'smtp.gmail.com'  \n    PORT = '465'\n    CONTEXT= ssl.create_default_context()\n    from_password= \"\"     \n    i=2\n    while(i<=numRows):\n        if ((sheet.cell(i,7).value)==districtId and sheet.cell(i,1).value == \"No\"):\n            print(str(sheet.cell(i,7).value))\n            print(sheet.cell(i,3).value)\n            msg = MIMEMultipart('alternative')\n            email_message = \"\"\n            msg['From'] = \"Ayush Kapoor ayushmailer111@gmail.com\"\n            msg['Subject'] = \"ATTENTION: CoWin Vaccination slots for 18+ available at \"+ str(len(data))+\" centres in \"+sheet.cell(i,6).value+', '+sheet.cell(i,5).value\n            msg['To'] = sheet.cell(i,4).value\n            print(sheet.cell(i,4).value)"}, {"id": "CowinService.py_18", "file": "CowinService.py", "content": "msg['To'] = sheet.cell(i,4).value\n            print(sheet.cell(i,4).value)\n            email_message= JSON2HTML(data, sheet.cell(i,3).value)\n            part1 = MIMEText(email_message, 'html')\n            msg.attach(part1)\n            with smtplib.SMTP_SSL(host=HOSTNAME,port=PORT,context=CONTEXT) as server:\n                server.login(msg['From'].split(' ')[2],from_password)\n                server.sendmail(msg['From'],msg['To'],msg.as_string())\n        i+=1 \n    \n#%% \n#fetchStateDistrict()\n#%% Main Driver setup \nurllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)\ncowin_api_url2 = \"https://api.cowin.gov.in/api/v2/appointment/sessions/public/calendarByDistrict\"\ncowin_api_url = \"https://cdn-api.co-vin.in/api/v2/appointment/sessions/public/calendarByDistrict\""}, {"id": "CowinService.py_19", "file": "CowinService.py", "content": "cowin_api_url = \"https://cdn-api.co-vin.in/api/v2/appointment/sessions/public/calendarByDistrict\"\ndistrictCodes = []\nwhile True:\n    i=2\n    while(i<=sheet.cell(2,9).value):\n        if (sheet.cell(i,1).value ==\"No\" and sheet.cell(i,6).value!=\"\"):\n            print('* '+sheet.cell(i,3).value+' | '+ str(sheet.cell(i,7).value))\n            districtCodes.append(sheet.cell(i,7).value)\n        i+=1  \n    numRows = i-1\n    districtCodes = list(set(districtCodes))\n    print('-----Last Row: '+str(numRows))\n    for j in range(0,len(districtCodes)):\n        print('------>'+str(districtCodes[j]))\n        fetchDetails(cowin_api_url2,districtCodes[j],numRows)\n    print('--------Last Fetched: '+datetime.now().strftime(\"%d/%m/%Y %H:%M:%S\")+'------')\n    time.sleep(600)"}, {"id": "sendRegMails.gs_0", "file": "sendRegMails.gs", "content": "================================================\n//Function to send inital registration email to the users\nfunction sendRegMails()\n{\n  Utilities.sleep(20000);\n  var sub= \"ATTENTION: CoWin Vaccination Scouting Registration Successful\"\n  const htmlTemp = HtmlService.createTemplateFromFile(\"RegMailTemp\");\n  var ws = SpreadsheetApp.openById(ssID).getSheetByName(\"Response Database\")\n  var Avals = ws.getRange(\"D1:D\").getValues();\n  //Logger.log(Avals.filter(String).length)\n  for (var i =2; i<= Avals.filter(String).length+1;i++)\n  {\n    if((ws.getRange(i,2,1,1).getValue()==\"No\") && (ws.getRange(i,6,1,1).getValue()!=\"\") && (ws.getRange(i,9,1,1).getValue()==\"\"))\n    {\n        // Changing name to first name with formatting"}, {"id": "sendRegMails.gs_1", "file": "sendRegMails.gs", "content": "{\n        // Changing name to first name with formatting\n        var temp = ws.getRange(i,4,1,1).getValue().split(\" \")[0].toLowerCase().replace(/\\b[a-z]/ig, function(match) {return match.toUpperCase()})\n        if (temp.length<=2)\n        {\n          htmlTemp.name = ws.getRange(i,4,1,1)\n          ws.getRange(i,5,1,1).setValue(ws.getRange(i,4,1,1))\n        }\n        if(temp.length>2)\n        {\n          htmlTemp.name = temp\n          ws.getRange(i,5,1,1).setValue(temp)\n        }\n        htmlTemp.email= ws.getRange(i,6,1,1).getValue();\n        htmlTemp.district = ws.getRange(i,8,1,1).getValue();\n        htmlTemp.state = ws.getRange(i,7,1,1).getValue();\n        var message1 = htmlTemp.evaluate().getContent();\n        //console.log(message1);"}, {"id": "sendRegMails.gs_2", "file": "sendRegMails.gs", "content": "var message1 = htmlTemp.evaluate().getContent();\n        //console.log(message1);\n        GmailApp.sendEmail(ws.getRange(i,6,1,1).getValue(),sub,\"Text\",{name:\"Ayush Kapoor\",htmlBody: message1});\\\n        // Update the status of the registration mail\n        ws.getRange(i,2,1,1).setValue('Yes')\n    }  \n  }\n}"}]